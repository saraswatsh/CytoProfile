---
title: "Getting Started with CytoProfile"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with CytoProfile}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
   collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center",
  fig.retina = 2,
  dpi = 96,
  out.width = "100%",
  fig.width = 7,
  fig.height = 5
)
```

# CytoProfile <a href="https://cytoprofile.cytokineprofile.org/"><img src="../man/figures/logo.png" alt="CytoProfile website" align="right" height="133"/></a>

The goal of CytoProfile is to conduct quality control using biological meaningful cutoff on raw measured values of cytokines. Specifically, test on distributional symmetry to suggest the adopt of transformation. Conduct exploratory analysis including summary statistics, generate enriched barplots, and boxplots. Further, conduct univariate analysis and multivariate analysis for advance analysis.

## Installation

Before installation of the CytoProfile package, make sure to install BiocManager and mixOmics packages using:

``` r
## install BiocManager
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager") 
## install mixOmics 
BiocManager::install('mixOmics')
```

You can install the development version of CytoProfile from [GitHub](https://github.com/saraswatsh/CytoProfile/tree/devel) with:

``` r
# install.packages("devtools")
devtools::install_github("saraswatsh/CytoProfile", ref = "devel")
```

Install CytoProfile from [CRAN](https://cran.r-project.org/package=CytoProfile) with:

``` r
install.packages("CytoProfile")
```

## Example

Below are examples of using the functions provided in CytoProfile.

## 1. Data Loading and set up

```{r, setup, cache=TRUE}
# Load in the CytoProfile package
library(CytoProfile)
# dplyr is used below for data subsetting; it is not re-exported by CytoProfile
# so we load it explicitly here. All other functions used are from CytoProfile.
library(dplyr)
# Loading in data
data("ExampleData1")
data_df <- ExampleData1
```

## 2. Exploratory Data Analysis

### Boxplots

```{r, EDA1, cache=TRUE}
# Boxplots without grouping with log2 scaling
data_df <- ExampleData1
cyt_bp(data_df[, -c(1:3)], output_file= NULL, scale = "log2")
# Boxplots grouped by Group with z-score scaling
cyt_bp(data_df[, -c(3,5:28)], group_by = "Group", scale = "zscore")
```

```{r, EDA2, cache=TRUE}
data_df <- ExampleData1
# Violin plots without grouping
cyt_violin(data_df[, -c(1:3)], output_file= NULL, scale = "zscore")
# Violin plots grouped by Group with boxplot overlay
cyt_violin(data_df[, -c(3,5:28)], group_by = "Group",
                         boxplot_overlay = TRUE, scale = "log2")
```


## 3. Skewness and Kurtosis

```{r, EDA3, cache=TRUE}
data_df <- ExampleData1
# Histogram of skewness and kurtosis for raw data
cyt_skku(data_df[, -c(1:3)], output_file= NULL, group_cols = NULL)

# Histogram of skewness and kurtosis with grouping (e.g., "Group")
cyt_skku(data_df[, -c(2:3)], output_file= NULL, group_cols = c("Group"))
```

## 4. Error Bar Plots

### Basic Error Bar Plot

```{r,EDA4, cache=TRUE, fig.height = 7.5}
 # Basic usage with default settings
data_df <- ExampleData1[, c("Group", "CCL-20/MIP-3A", "IL-10")]
cyt_errbp(data_df, group_col = "Group", x_lab = "Cytokines",
  y_lab = "Concentrations in log2 scale")

# Use mean and SD, log2 transform and show significance with symbols
cyt_errbp(data_df, group_col = "Group", stat = "mean", error = "sd",
           scale = "log2", class_symbol = TRUE, method = "ttest",  
           x_lab = "Cytokines", y_lab = "Concentrations in log2 scale")
```

## 5. Univariate Analysis

### Two Sample T-test and Mann Whitney U Test

```{r, Univariate1, cache=TRUE}
# Performing Test
data <- ExampleData1[, -c(3)]
data_df <- dplyr::filter(data, Group != "ND", Treatment != "Unstimulated")
cyt_univariate(data_df[, c(1:2, 5:6)], scale = "log2",
                method = "auto", format_output = TRUE)
```

### ANOVA Comparisons Test

```{r,Univariate2, cache=TRUE}
# Perform ANOVA comparisons test (example with 2 cytokines)
cyt_univariate_multi(ExampleData1[, c(1:2, 5:6)], method = "kruskal",
                     format_output = TRUE)
```

## 6. Multivariate Analysis

### Sparse Partial Least Squares Discriminant Analysis (sPLS-DA)

```{r, Multivariate1, cache=TRUE, fig.show = 'hide'}
# cyt_plsda function.
data <- ExampleData1[, -c(3)]
data_df <- dplyr::filter(data, Group != "ND" & Treatment == "CD3/CD28")
results <- cyt_splsda(
  data_df,
  output_file = NULL,
  colors = c("black", "purple"),
  bg = FALSE,
  scale = "log2",
  ellipse = TRUE,
  conf_mat = FALSE,
  var_num = 25,
  cv_opt = "loocv",
  comp_num = 2,
  pch_values = c(16, 4),
  group_col = "Group",
  group_col2 = "Treatment",
  roc = TRUE
)
```

```{r, Multivariate1.1, fig.show = "hold", fig.width = 10, echo = FALSE, cache=TRUE}
results$overall_indiv_plot
results$loadings$Comp1()
results$vip_scores$Comp1()
results$vip_indiv_plot
results$vip_loadings$Comp1()
```

### Multivariate INTegration Partial Least Squares Discriminant Analysis (MINT sPLS-DA)

```{r, Multivariate2, cache=TRUE, fig.show = 'hide'}
# cyt_mint_plsda function.
data <- ExampleData5[, -c(2, 4)]
data_df <- dplyr::filter(data, Group != "ND")

results <- cyt_mint_splsda(
  data_df,
  group_col = "Group",
  batch_col = "Batch",
  colors = c("black", "purple"),
  ellipse = TRUE,
  var_num = 25,
  comp_num = 2,
  scale = "log2",
  verbose = FALSE
)
```

```{r, Multivariate2.1, fig.show = "hold", fig.width = 10, echo = FALSE, cache=TRUE}
results$global_indiv_plot
results$global_loadings_plots$Comp1()
results$partial_indiv_plot
```

### Principal Component Analysis (PCA)

```{r, Multivariate3, cache=TRUE, fig.show = 'hide'}
data <- ExampleData1[, -c(3, 23)]
data_df <- dplyr::filter(data, Group != "ND" & Treatment != "Unstimulated")
results <- cyt_pca(
  data_df,
  output_file = NULL,
  colors = c("black", "red2"),
  scale = "log2",
  comp_num = 2,
  pch_values = c(16, 4),
  group_col = "Group"
)
```

```{r, Multivariate3.1, fig.show = "hold", fig.width = 10, echo = FALSE, cache=TRUE}
results$overall_indiv_plot
results$loadings$Comp1()
results$biplot
results$scree_plot
results$correlation_circle()
```

## 7. Statistical Visualizations

### Volcano Plot

```{r, EDA6, cache=TRUE}
# Generating Volcano Plot
data_df <- ExampleData1[,-c(2:3)]
cyt_volc(data_df, "Group", cond1 = "T2D", cond2 = "ND", fold_change_thresh = 2.0, top_labels= 15)
```

### Heatmap

```{r,EDA7, cache=TRUE}
data_df <- ExampleData1
# Generate a heatmap with log2 scaling and annotation based on
# the "Group" column
cyt_heatmap(
  data = data_df[, -c(2:3)],
  scale = "log2",  # Optional scaling
  annotation_col = "Group",
  annotation_side = "auto",
  title = NULL
)
```

### Dual Flashlight Plot

```{r,EDA8, cache=TRUE}
# Generating dual flashlights plot
data_df <- ExampleData1[, -c(2:3)]
dfp <- cyt_dualflashplot(data_df, group_var = "Group", group1 = "T2D", group2 = "ND",
                        ssmd_thresh = 0.2, log2fc_thresh = 1,
                        top_labels = 10)
dfp
# Print the table data used for plotting
print(dfp$data, n = 25)
```

## 8. Machine Learning Models

### Using XGBoost for classification

```{r, ML1, cache=TRUE}
# Using XGBoost for classification
data <- data.frame(ExampleData1[, 1:3], log2(ExampleData1[, -c(1:3)]))
data <- data[, -c(2:3)]
data_df <- dplyr::filter(data, Group != "ND")

cyt_xgb(
  data = data_df,
  group_col = "Group",
  nrounds = 500,
  max_depth = 4,
  min_split_loss = 0,
  learning_rate = 0.05,
  nfold = 5,
  cv = TRUE,
  objective = "multi:softprob",
  eval_metric = "auc",
  early_stopping_rounds = NULL,
  top_n_features = 10,
  verbose = 0,
  plot_roc = TRUE,
  print_results = FALSE
)
```

### Using Random Forest for classification

```{r,ML2, cache=TRUE}
# Using Random Forest for classification
cyt_rf(
  data = data_df,
  group_col = "Group",
  k_folds = 5,
  ntree = 1000,
  mtry = 4,
  run_rfcv = TRUE,
  plot_roc = TRUE,
  verbose = FALSE
)
```